<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Screen configuration</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, rgba(59,130,246,0.25), transparent 55%), #020617;
      padding: clamp(1rem, 3vw, 2.5rem);
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .page__header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
    }
    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 4vw, 2.6rem);
      letter-spacing: 0.02em;
    }
    p {
      margin: 0.35rem 0 0;
      color: #94a3b8;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22d3ee, #6366f1);
      color: #020617;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
      transition: transform 120ms ease, opacity 120ms ease;
    }
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:not(:disabled):active {
      transform: translateY(2px);
    }
    .status {
      min-height: 1.5rem;
      font-weight: 600;
      color: #94a3b8;
    }
    .status[data-tone="success"] { color: #86efac; }
    .status[data-tone="error"] { color: #fca5a5; }
    .status[data-tone="info"] { color: #93c5fd; }
    .config-panel {
      background: rgba(15, 23, 42, 0.75);
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 25px 50px rgba(15, 23, 42, 0.45);
    }
    .config-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
    }
    .config-header h2 {
      margin: 0;
      font-size: 1.4rem;
    }
    .config-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .config-actions button.secondary {
      background: rgba(148, 163, 184, 0.12);
      color: #e2e8f0;
      box-shadow: none;
    }
    .config-error {
      border: 1px solid rgba(248,113,113,0.6);
      background: rgba(248,113,113,0.08);
      padding: 0.75rem 1rem;
      border-radius: 16px;
      color: #fecaca;
      font-weight: 600;
    }
    .config-table {
      display: grid;
      grid-template-columns: 40px minmax(160px, 1.5fr) minmax(120px, 0.9fr) minmax(220px, 1.4fr) minmax(140px, 0.9fr);
      gap: 0.75rem 1rem;
      align-items: center;
    }
    .config-table__header {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
    }
    .config-row {
      display: contents;
    }
    .config-cell {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
      padding: 0.65rem 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }
    .config-cell input {
      width: 100%;
      border: none;
      background: transparent;
      color: inherit;
      font-size: 0.95rem;
      outline: none;
    }
    .drag-handle {
      cursor: grab;
      font-size: 1.2rem;
      text-align: center;
      user-select: none;
    }
    .dragging .config-cell {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <main class="page">
    <header class="page__header">
      <div>
        <h1>Screen configuration</h1>
        <p>Reorder screens and adjust frequencies for the active playlist.</p>
      </div>
    </header>
    <section class="config-panel" aria-label="Screen configuration">
      <div class="config-header">
        <div>
          <h2>Playlist editor</h2>
          <p>Drag to reorder, set frequencies, and add alternate screens.</p>
        </div>
        <div class="config-actions">
          <button type="button" class="config-save" disabled>Save changes</button>
          <button type="button" class="secondary config-defaults">Load defaults</button>
          <button type="button" class="secondary config-export">Export configuration</button>
        </div>
      </div>
      <div class="status" id="config-status" aria-live="polite"></div>
      <div class="config-error" id="config-error" hidden></div>
      <div class="config-table config-table__header" aria-hidden="true">
        <div>Drag</div>
        <div>Screen</div>
        <div>Frequency</div>
        <div>Alternate screens</div>
        <div>Alternate frequency</div>
      </div>
      <div class="config-table" id="config-list"></div>
      <div class="config-actions">
        <button type="button" class="config-save" disabled>Save changes</button>
        <button type="button" class="secondary config-defaults">Load defaults</button>
        <button type="button" class="secondary config-export">Export configuration</button>
      </div>
    </section>
  </main>
  <script>
    (() => {
      const configList = document.getElementById('config-list');
      const configStatus = document.getElementById('config-status');
      const configError = document.getElementById('config-error');
      const configSaveButtons = Array.from(document.querySelectorAll('.config-save'));
      const configDefaultsButtons = Array.from(document.querySelectorAll('.config-defaults'));
      const configExportButtons = Array.from(document.querySelectorAll('.config-export'));
      let configDirty = false;

      function setConfigStatus(message, tone = 'info') {
        configStatus.textContent = message;
        configStatus.dataset.tone = tone;
      }

      function setConfigError(message = '') {
        if (!message) {
          configError.hidden = true;
          configError.textContent = '';
          return;
        }
        configError.hidden = false;
        configError.textContent = message;
      }

      function markConfigDirty(isDirty) {
        configDirty = isDirty;
        configSaveButtons.forEach((button) => {
          button.disabled = !configDirty;
        });
      }

      function renderConfigRows(screens) {
        configList.innerHTML = '';
        screens.forEach((screen) => {
          const row = document.createElement('div');
          row.className = 'config-row';
          row.dataset.screenId = screen.id;
          row.draggable = true;

          row.innerHTML = `
            <div class="config-cell drag-handle" title="Drag to reorder" aria-label="Drag handle">⠿</div>
            <div class="config-cell">${screen.id}</div>
            <div class="config-cell">
              <input type="number" min="0" inputmode="numeric" class="freq-input" value="${screen.frequency ?? ''}">
            </div>
            <div class="config-cell">
              <input type="text" class="alt-screen-input" placeholder="alternate_a, alternate_b" value="${screen.alt_screen ?? ''}">
            </div>
            <div class="config-cell">
              <input type="number" min="0" inputmode="numeric" class="alt-frequency-input" placeholder="Optional" value="${screen.alt_frequency ?? ''}">
            </div>
          `;

          row.querySelectorAll('input').forEach((input) => {
            input.addEventListener('input', () => {
              markConfigDirty(true);
            });
          });

          row.addEventListener('dragstart', (event) => {
            const handle = event.target.closest('.drag-handle');
            if (!handle) {
              event.preventDefault();
              return;
            }
            row.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
          });

          row.addEventListener('dragend', () => {
            row.classList.remove('dragging');
            markConfigDirty(true);
          });

          configList.appendChild(row);
        });
      }

      function getDragAfterElement(container, y) {
        const draggableElements = Array.from(container.querySelectorAll('.config-row:not(.dragging)'));
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset, element: child };
          }
          return closest;
        }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
      }

      configList.addEventListener('dragover', (event) => {
        event.preventDefault();
        const afterElement = getDragAfterElement(configList, event.clientY);
        const dragging = configList.querySelector('.dragging');
        if (!dragging) {
          return;
        }
        if (afterElement == null) {
          configList.appendChild(dragging);
        } else {
          configList.insertBefore(dragging, afterElement);
        }
      });

      function buildConfigPayload() {
        const rows = Array.from(configList.querySelectorAll('.config-row'));
        return {
          screens: rows.map((row) => ({
            id: row.dataset.screenId,
            frequency: row.querySelector('.freq-input').value,
            alt_screen: row.querySelector('.alt-screen-input').value,
            alt_frequency: row.querySelector('.alt-frequency-input').value,
          })),
        };
      }

      async function loadConfig(url) {
        setConfigError('');
        setConfigStatus('Loading screen configuration…', 'info');
        const resp = await fetch(url);
        const payload = await resp.json();
        if (!resp.ok || payload.status !== 'ok') {
          throw new Error(payload.message || 'Unable to load configuration');
        }
        renderConfigRows(payload.screens || []);
        markConfigDirty(false);
        setConfigStatus('Configuration loaded.', 'success');
      }

      async function saveConfig() {
        setConfigError('');
        setConfigStatus('Saving screen configuration…', 'info');
        const resp = await fetch('/api/screens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(buildConfigPayload()),
        });
        const payload = await resp.json();
        if (!resp.ok || payload.status !== 'ok') {
          throw new Error(payload.message || 'Unable to save configuration');
        }
        markConfigDirty(false);
        setConfigStatus('Configuration saved to device override.', 'success');
      }

      configSaveButtons.forEach((button) => {
        button.addEventListener('click', async () => {
          button.disabled = true;
          try {
            await saveConfig();
          } catch (err) {
            setConfigError(err.message);
            setConfigStatus('Save failed.', 'error');
            markConfigDirty(true);
          } finally {
            button.disabled = !configDirty;
          }
        });
      });

      configDefaultsButtons.forEach((button) => {
        button.addEventListener('click', async () => {
          try {
            await loadConfig('/api/screens/defaults');
          } catch (err) {
            setConfigError(err.message);
            setConfigStatus('Unable to load defaults.', 'error');
          }
        });
      });

      configExportButtons.forEach((button) => {
        button.addEventListener('click', () => {
          window.location.href = '/api/screens/export';
        });
      });

      loadConfig('/api/screens').catch((err) => {
        setConfigError(err.message);
        setConfigStatus('Unable to load configuration.', 'error');
      });
    })();
  </script>
</body>
</html>

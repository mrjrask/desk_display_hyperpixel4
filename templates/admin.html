<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Screen tuning</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, rgba(59,130,246,0.25), transparent 55%), #020617;
      padding: clamp(1rem, 3vw, 2.5rem);
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .page__header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
    }
    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 4vw, 2.8rem);
      letter-spacing: 0.02em;
    }
    p {
      margin: 0.35rem 0 0;
      color: #94a3b8;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22d3ee, #6366f1);
      color: #020617;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
      transition: transform 120ms ease, opacity 120ms ease;
    }
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:not(:disabled):active {
      transform: translateY(2px);
    }
    .status {
      min-height: 1.5rem;
      font-weight: 600;
      color: #94a3b8;
    }
    .status[data-tone="success"] { color: #86efac; }
    .status[data-tone="error"] { color: #fca5a5; }
    .status[data-tone="info"] { color: #93c5fd; }
    .error {
      border: 1px solid rgba(248,113,113,0.6);
      background: rgba(248,113,113,0.08);
      padding: 0.75rem 1rem;
      border-radius: 16px;
      color: #fecaca;
      font-weight: 600;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
    }
    .screen-card {
      position: relative;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.45);
    }
    .screen-card--dirty::after {
      content: "Unsaved";
      position: absolute;
      top: 0.75rem;
      right: 1rem;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #fcd34d;
    }
    .screen-card__title {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .screen-card__title h2 {
      margin: 0;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .screen-card__title span {
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .screenshot {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(30, 41, 59, 0.6);
      object-fit: cover;
    }
    .screenshot--empty {
      display: grid;
      place-items: center;
      font-style: italic;
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .timestamp {
      font-size: 0.85rem;
      color: #94a3b8;
    }
    .override-groups {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .override-group {
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 16px;
      padding: 1rem;
      background: rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .override-group h3 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #f8fafc;
    }
    .override-group p {
      color: #94a3b8;
      font-size: 0.85rem;
      margin: 0;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.9rem;
      color: #cbd5f5;
    }
    input[type="number"], select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      outline: none;
      transition: border-color 120ms ease;
    }
    input[type="number"]:focus, select:focus {
      border-color: #38bdf8;
    }
    input.invalid {
      border-color: #f87171;
    }
    small {
      color: #64748b;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <main class="page">
    <header class="page__header">
      <div>
        <h1>Screen tuning</h1>
        <p>Adjust font sizes, image scale, and device profiles for each scheduled screen.</p>
      </div>
      <button id="save-all" type="button" disabled>Save changes</button>
    </header>
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
    <div class="status" id="status" aria-live="polite"></div>
    <section class="grid">
      {% for screen in screens %}
        <article class="screen-card" data-screen-id="{{ screen.id }}">
          <div class="screen-card__title">
            <h2>{{ screen.id }}</h2>
            <span>Every {{ screen.frequency }} loop{{ '' if screen.frequency == 1 else 's' }}</span>
          </div>
          {% if screen.last_screenshot %}
            <img class="screenshot" src="{{ url_for('static', filename=screen.last_screenshot) }}" alt="Latest screenshot for {{ screen.id }}">
            {% if screen.last_captured %}
              <div class="timestamp">Captured {{ screen.last_captured }}</div>
            {% endif %}
          {% else %}
            <div class="screenshot screenshot--empty">No screenshot captured yet</div>
          {% endif %}
          <div class="override-groups">
            {% set defaults = screen.overrides.defaults %}
            <section class="override-group" data-profile="defaults">
              <h3>Shared defaults</h3>
              <p>Applied to every display profile unless a targeted override is defined.</p>
              <label>
                Font scale multiplier
                <input
                  type="number"
                  min="0.25"
                  max="5"
                  step="0.05"
                  inputmode="decimal"
                  placeholder="Inherit global"
                  class="override-input"
                  data-field="font_scale"
                  data-profile="defaults"
                  value="{{ '%.4g'|format(defaults.font_scale) if defaults.font_scale is defined else '' }}"
                >
                <small>Leave blank to use the display default.</small>
              </label>
              <label>
                Image scale multiplier
                <input
                  type="number"
                  min="0.25"
                  max="3"
                  step="0.05"
                  inputmode="decimal"
                  placeholder="Inherit global"
                  class="override-input"
                  data-field="image_scale"
                  data-profile="defaults"
                  value="{{ '%.4g'|format(defaults.image_scale) if defaults.image_scale is defined else '' }}"
                >
                <small>Dial in logos or maps without touching the base layout.</small>
              </label>
              <label>
                Device profile override
                <select class="override-input" data-field="device_profile" data-profile="defaults">
                  <option value="" {% if defaults.device_profile is not defined %}selected{% endif %}>Use global profile</option>
                  {% for value, label in device_profiles %}
                    <option value="{{ value }}" {% if defaults.device_profile == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <small>Force a specific HyperPixel layout when testing.</small>
              </label>
            </section>
            {% set profile_overrides = screen.overrides.profiles %}
            {% for value, label in device_profiles %}
              {% set entry = profile_overrides.get(value, {}) %}
              <section class="override-group" data-profile="{{ value }}">
                <h3>{{ label }}</h3>
                <p>Only applied when the display reports the <code>{{ value }}</code> profile.</p>
                <label>
                  Font scale multiplier
                  <input
                    type="number"
                    min="0.25"
                    max="5"
                    step="0.05"
                    inputmode="decimal"
                    placeholder="Inherit shared"
                    class="override-input"
                    data-field="font_scale"
                    data-profile="{{ value }}"
                    value="{{ '%.4g'|format(entry.font_scale) if entry.font_scale is defined else '' }}"
                  >
                  <small>Leave blank to inherit the shared defaults.</small>
                </label>
                <label>
                  Image scale multiplier
                  <input
                    type="number"
                    min="0.25"
                    max="3"
                    step="0.05"
                    inputmode="decimal"
                    placeholder="Inherit shared"
                    class="override-input"
                    data-field="image_scale"
                    data-profile="{{ value }}"
                    value="{{ '%.4g'|format(entry.image_scale) if entry.image_scale is defined else '' }}"
                  >
                  <small>Use when a hardware revision needs extra breathing room.</small>
                </label>
              </section>
            {% endfor %}
          </div>
        </article>
      {% endfor %}
    </section>
  </main>
  <script>
    (() => {
      const initial = {{ overrides | tojson }};
      const pending = Object.create(null);
      const saveBtn = document.getElementById('save-all');
      const statusEl = document.getElementById('status');

      function getInitial(screenId, profileKey, field) {
        const screen = initial[screenId];
        if (!screen) {
          return null;
        }
        if (profileKey === 'defaults') {
          return (screen.defaults && Object.prototype.hasOwnProperty.call(screen.defaults, field))
            ? screen.defaults[field]
            : null;
        }
        const profiles = screen.profiles || {};
        if (!Object.prototype.hasOwnProperty.call(profiles, profileKey)) {
          return null;
        }
        const profileEntry = profiles[profileKey];
        return Object.prototype.hasOwnProperty.call(profileEntry, field)
          ? profileEntry[field]
          : null;
      }

      function valuesEqual(a, b) {
        if (a == null && b == null) {
          return true;
        }
        if (typeof a === 'number' && typeof b === 'number') {
          return Math.abs(a - b) < 0.0001;
        }
        return a === b;
      }

      function cardFor(screenId) {
        return document.querySelector(`.screen-card[data-screen-id="${CSS.escape(screenId)}"]`);
      }

      function setStatus(message, tone = 'info') {
        statusEl.textContent = message;
        statusEl.dataset.tone = tone;
      }

      function validateInput(input) {
        if (input.type === 'number') {
          if (!input.value) {
            input.classList.remove('invalid');
            input.setCustomValidity('');
            return true;
          }
          const value = Number(input.value);
          const min = Number(input.min);
          const max = Number(input.max);
          if (Number.isNaN(value) || value < min || value > max) {
            input.classList.add('invalid');
            input.setCustomValidity(`Enter a value between ${min} and ${max}.`);
            return false;
          }
        }
        input.classList.remove('invalid');
        input.setCustomValidity('');
        return true;
      }

      function normaliseValue(input) {
        if (input.type === 'number') {
          return input.value ? Number(input.value) : null;
        }
        if (input.tagName === 'SELECT') {
          return input.value || null;
        }
        return input.value || null;
      }

      function ensurePending(screenId) {
        if (!pending[screenId]) {
          pending[screenId] = { defaults: {}, profiles: {} };
        }
        const entry = pending[screenId];
        if (!entry.defaults) {
          entry.defaults = {};
        }
        if (!entry.profiles) {
          entry.profiles = {};
        }
        return entry;
      }

      function cleanupPending(screenId) {
        const entry = pending[screenId];
        if (!entry) {
          return;
        }
        if (entry.defaults && Object.keys(entry.defaults).length === 0) {
          delete entry.defaults;
        }
        if (entry.profiles) {
          Object.keys(entry.profiles).forEach((profile) => {
            if (Object.keys(entry.profiles[profile]).length === 0) {
              delete entry.profiles[profile];
            }
          });
          if (Object.keys(entry.profiles).length === 0) {
            delete entry.profiles;
          }
        }
        if (!entry.defaults && !entry.profiles) {
          delete pending[screenId];
        }
      }

      function updatePending(screenId, profileKey, field, value) {
        const entry = ensurePending(screenId);
        const target = profileKey === 'defaults'
          ? (entry.defaults || (entry.defaults = {}))
          : ((entry.profiles[profileKey] = entry.profiles[profileKey] || {}));
        target[field] = value;
        if (valuesEqual(value, getInitial(screenId, profileKey, field))) {
          delete target[field];
        }
        cleanupPending(screenId);
        if (pending[screenId]) {
          cardFor(screenId)?.classList.add('screen-card--dirty');
        } else {
          cardFor(screenId)?.classList.remove('screen-card--dirty');
        }
        saveBtn.disabled = Object.keys(pending).length === 0;
      }

      function handleInput(event) {
        const input = event.target;
        if (!input.classList.contains('override-input')) {
          return;
        }
        if (!validateInput(input)) {
          return;
        }
        const card = input.closest('.screen-card');
        if (!card) {
          return;
        }
        const screenId = card.dataset.screenId;
        const field = input.dataset.field;
        const profileKey = input.dataset.profile || 'defaults';
        updatePending(screenId, profileKey, field, normaliseValue(input));
      }

      document.querySelectorAll('.override-input').forEach((input) => {
        input.addEventListener('input', handleInput);
        input.addEventListener('change', handleInput);
      });

      function serializePending() {
        const payload = {};
        for (const [screenId, fields] of Object.entries(pending)) {
          const entry = {};
          if (fields.defaults && Object.keys(fields.defaults).length > 0) {
            entry.defaults = { ...fields.defaults };
          }
          if (fields.profiles) {
            for (const [profile, values] of Object.entries(fields.profiles)) {
              if (Object.keys(values).length === 0) {
                continue;
              }
              if (!entry.profiles) {
                entry.profiles = {};
              }
              entry.profiles[profile] = { ...values };
            }
          }
          if (Object.keys(entry).length > 0) {
            payload[screenId] = entry;
          }
        }
        return payload;
      }

      function refreshInputs() {
        document.querySelectorAll('.screen-card').forEach((card) => {
          const screenId = card.dataset.screenId;
          card.querySelectorAll('.override-input').forEach((input) => {
            const field = input.dataset.field;
            const profileKey = input.dataset.profile || 'defaults';
            const value = getInitial(screenId, profileKey, field);
            if (input.type === 'number') {
              input.value = value == null ? '' : value;
            } else if (input.tagName === 'SELECT') {
              input.value = value || '';
            }
          });
        });
      }

      saveBtn.addEventListener('click', async () => {
        if (saveBtn.disabled) {
          return;
        }
        const inputs = Array.from(document.querySelectorAll('.override-input'));
        for (const input of inputs) {
          if (!validateInput(input)) {
            input.reportValidity();
            setStatus('Fix invalid values before saving.', 'error');
            return;
          }
        }

        const updates = serializePending();
        if (Object.keys(updates).length === 0) {
          setStatus('No changes to save.', 'info');
          return;
        }

        saveBtn.disabled = true;
        const originalLabel = saveBtn.textContent;
        saveBtn.textContent = 'Saving…';
        setStatus('Saving overrides…', 'info');
        try {
          const resp = await fetch('/api/overrides', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ screens: updates }),
          });
          const payload = await resp.json();
          if (!resp.ok || payload.status !== 'ok') {
            throw new Error(payload.message || 'Unable to save overrides');
          }
          for (const key of Object.keys(initial)) {
            if (!(key in payload.overrides)) {
              delete initial[key];
            }
          }
          Object.entries(payload.overrides).forEach(([key, value]) => {
            initial[key] = value;
          });
          Object.keys(pending).forEach((key) => {
            delete pending[key];
            cardFor(key)?.classList.remove('screen-card--dirty');
          });
          refreshInputs();
          setStatus('Overrides saved.', 'success');
        } catch (err) {
          setStatus(err.message || 'Save failed', 'error');
        } finally {
          saveBtn.textContent = originalLabel;
          saveBtn.disabled = Object.keys(pending).length === 0;
        }
      });
    })();
  </script>
</body>
</html>
